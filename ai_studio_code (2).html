<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inelastic Supply and Demand: Da Vinci Paintings</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0c10;
            --card: #111318;
            --ink: #e8eaed;
            --muted: #b8c1cc;
            --demand: #3b82f6;
            --supply: #f59e0b;
            --accent: #22c55e;
            --axis: #97a3b6;
            --grid: #2a2f39;
            --shortage: rgba(239, 68, 68, 0.2);
            --shortage-stroke: #ef4444;
            --surplus: rgba(59, 130, 246, 0.2);
            --surplus-stroke: #3b82f6;
        }

        html, body {
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--ink);
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            display: grid;
            place-content: center;
            min-height: 100vh;
        }

        .wrap {
            max-width: 900px;
            margin: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 24px;
        }
        header h1 {
            font-size: 1.75rem;
            margin: 0 0 8px;
        }
        header p {
            margin: 0;
            color: var(--muted);
            max-width: 600px;
            margin: 0 auto;
        }

        .layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 18px;
        }
        @media (max-width: 800px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card);
            border: 1px solid #1b1f27;
            border-radius: 14px;
            box-shadow: 0 1px 0 rgba(255, 255, 255, 0.03) inset;
        }
        .card .pad {
            padding: 18px;
        }
        .graph-container {
             padding: 10px;
        }

        svg {
            display: block;
            width: 100%;
            height: auto;
            background: linear-gradient(180deg, #0f1319 0%, #0e1217 100%);
            border-radius: 14px;
        }

        .axis path, .axis line { stroke: var(--axis); }
        .axis text { fill: var(--ink); font-size: 12px; }
        .grid .tick line { stroke: var(--grid); }
        .axis-title {
            font-size: 13px;
            fill: var(--muted);
            text-anchor: middle;
        }

        .line { fill: none; stroke-width: 3px; }
        .line.demand { stroke: var(--demand); }
        .line.supply { stroke: var(--supply); }

        .dropline { stroke: var(--muted); stroke-width: 1px; stroke-dasharray: 2; }
        .equilibrium-point { stroke: var(--ink); stroke-width: 1.5px; fill: var(--ink); }
        .controlled-price-line { stroke: var(--accent); stroke-width: 1.5px; stroke-dasharray: 4; }

        .imbalance-area { stroke-width: 1.5px; }
        .imbalance-area.shortage { fill: var(--shortage); stroke: var(--shortage-stroke); }
        .imbalance-area.surplus { fill: var(--surplus); stroke: var(--surplus-stroke); }
        .imbalance-label { font-size: 11px; text-anchor: middle; }


        .draggable { cursor: pointer; touch-action: none; }
        .draggable.ns-resize { cursor: ns-resize; }

        /* Controls */
        .controls { display: grid; grid-template-columns: 1fr; gap: 16px; }
        .control { display: grid; grid-template-columns: 100px 1fr 50px; align-items: center; gap: 12px; }
        .control label { color: var(--muted); font-size: 0.9rem; }
        .control input[type=range] { width: 100%; }
        .control output { justify-self: end; font-variant-numeric: tabular-nums; font-size: 0.9rem; }
        .hint { color: var(--muted); font-size: 0.9rem; margin-top: 8px; grid-column: 1 / -1;}
        .control.price-control-group { grid-template-columns: 1fr; }
        .price-control-group fieldset { border: 1px solid #20283a; border-radius: 8px; padding: 12px; }
        .price-control-group legend { font-size: 0.9rem; color: var(--muted); padding: 0 6px; }
        .price-control-group .btn-group { display: flex; gap: 8px; margin-bottom: 12px; }
        .btn-group button { flex-grow: 1; background: #1b2130; border: 1px solid #253047; color: var(--muted); padding: 6px 10px; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
        .btn-group button:hover { background: #253047; }
        .btn-group button.active { background: var(--accent); color: var(--ink); border-color: var(--accent); }
        .price-control-slider-container { display: grid; grid-template-columns: 1fr 50px; gap: 12px; align-items: center;}
        .price-control-group input[type=range]:disabled { opacity: 0.4; }


        /* Readout */
        .readout { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 24px; }
        .stat { background: #0e1420; border: 1px solid #20283a; border-radius: 10px; padding: 12px; }
        .stat h3 { margin: 0 0 6px; font-size: 0.9rem; color: var(--muted); }
        .stat .val { font-size: 1.25rem; color: var(--accent); }
        .stat .val.danger { color: var(--shortage-stroke); }
        .stat .val.info { color: var(--surplus-stroke); }
        .stat .sub {font-size: 0.85rem; color: var(--muted); }

    </style>
</head>
<body>
    <div class="wrap">
        <header>
            <h1>The Market for Da Vinci Paintings</h1>
            <p>With only about 15 authenticated paintings in existence, the supply is fixed. Use the price control to set a price floor/ceiling and see how it creates a shortage or surplus.</p>
        </header>

        <div class="layout">
            <section class="card">
                <div class="graph-container">
                    <div id="sd-graph"></div>
                </div>
            </section>

            <aside class="card">
                <div class="pad">
                    <h2 style="margin-top:0">Controls</h2>
                    <div class="controls" role="group">
                        <div class="control">
                            <label for="demand-shift-slider">Demand Shift</label>
                            <input type="range" id="demand-shift-slider" min="-200" max="200" value="0" step="2">
                            <output id="demand-shift-val">0</output>
                        </div>
                        
                        <div class="control price-control-group">
                            <fieldset>
                                <legend>Price Control</legend>
                                <div class="btn-group">
                                    <button id="btn-market-price" class="active">Market Price</button>
                                    <button id="btn-set-price">Set Price</button>
                                </div>
                                <div class="price-control-slider-container">
                                    <input type="range" id="price-control-slider" min="0" max="500" value="250" step="5" disabled>
                                    <output id="price-control-val">$250M</output>
                                </div>
                            </fieldset>
                        </div>

                    </div>

                    <div class="readout" aria-live="polite">
                        <div class="stat">
                            <h3>Market Price</h3>
                            <div class="val" id="rPrice">$250.0M</div>
                        </div>
                        <div class="stat">
                            <h3>Quantity Transacted</h3>
                             <div class="val" id="rQuantity">15</div>
                        </div>
                        <div class="stat">
                            <h3>Market Status</h3>
                            <div class="val" id="rStatus">Equilibrium</div>
                            <div class="sub" id="rStatusSub">Qd = Qs</div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // --- 0. HELPER FUNCTION ---
        function getClippedLineEndpoints(slope, intercept, xDomain, yDomain) {
            const [xMin, xMax] = xDomain; const [yMin, yMax] = yDomain; const points = new Set();
            if (slope === 0) { if (intercept >= yMin && intercept <= yMax) { points.add(`${xMin},${intercept}`); points.add(`${xMax},${intercept}`); }
            } else {
                let xAtYMin = (yMin - intercept) / slope; if (xAtYMin >= xMin && xAtYMin <= xMax) points.add(`${xAtYMin},${yMin}`);
                let xAtYMax = (yMax - intercept) / slope; if (xAtYMax >= xMin && xAtYMax <= xMax) points.add(`${xAtYMax},${yMax}`);
                let yAtXMin = slope * xMin + intercept; if (yAtXMin >= yMin && yAtXMin <= yMax) points.add(`${xMin},${yAtXMin}`);
                let yAtXMax = slope * xMax + intercept; if (yAtXMax >= yMin && yAtXMax <= yMax) points.add(`${xMax},${yAtXMax}`);
            }
            const uniquePoints = Array.from(points).map(p => { const [x, y] = p.split(',').map(Number); return { x, y }; });
            return uniquePoints.length >= 2 ? uniquePoints : null;
        }

        // --- 1. SETUP ---
        const params = {
            demandShift: 0,
            fixedQuantity: 15,
            baseIntercept: 450,
            demandSlope: -13.33,
            priceControl: null,
        };

        const els = {
            demandSlider: d3.select("#demand-shift-slider"), demandVal: d3.select("#demand-shift-val"),
            priceControlSlider: d3.select("#price-control-slider"), priceControlVal: d3.select("#price-control-val"),
            btnMarketPrice: d3.select("#btn-market-price"), btnSetPrice: d3.select("#btn-set-price"),
            rPrice: d3.select("#rPrice"), rQuantity: d3.select("#rQuantity"),
            rStatus: d3.select("#rStatus"), rStatusSub: d3.select("#rStatusSub"),
        };

        const margin = { top: 20, right: 30, bottom: 50, left: 60 };
        const width = 550 - margin.left - margin.right;
        const height = 450 - margin.top - margin.bottom;

        const svg = d3.select("#sd-graph").append("svg").attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
        const x = d3.scaleLinear().domain([0, 30]).range([0, width]);
        const y = d3.scaleLinear().domain([0, 500]).range([height, 0]);

        svg.append('g').attr('class', 'grid').call(d3.axisLeft(y).tickSize(-width).tickFormat(''));
        svg.append("g").attr("class", "axis").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));
        svg.append("g").attr("class", "axis").call(d3.axisLeft(y).tickFormat(d => `$${d}M`));
        svg.append("text").attr("class", "axis-title").attr("x", width / 2).attr("y", height + margin.bottom - 10).text("Quantity of Paintings");
        svg.append("text").attr("class", "axis-title").attr("transform", "rotate(-90)").attr("x", -height / 2).attr("y", -margin.left + 20).text("Price (Millions USD)");

        // --- 2. ADD GRAPH ELEMENTS ---
        const imbalanceArea = svg.append("rect").attr("class", "imbalance-area").attr("height", 10).style("visibility", "hidden");
        const imbalanceLabel = svg.append("text").attr("class", "imbalance-label").style("visibility", "hidden");
        const supplyCurve = svg.append("line").attr("class", "line supply");
        const demandCurve = svg.append("line").attr("class", "line demand");
        const demandDraggable = svg.append("line").attr("class", "draggable ns-resize").style("stroke", "transparent").style("stroke-width", 20);
        const controlledPriceLine = svg.append("line").attr("class", "controlled-price-line").style("visibility", "hidden");
        const equilDropQ = svg.append("line").attr("class", "dropline");
        const equilDropP = svg.append("line").attr("class", "dropline");
        const equilPoint = svg.append("circle").attr("r", 5).attr("class", "equilibrium-point");

        // --- 3. CORE UPDATE FUNCTION ---
        function update() {
            const dShift = +params.demandShift;
            const demandIntercept = params.baseIntercept + dShift;
            const quantitySupplied = params.fixedQuantity;
            
            // Calculations
            const equilibriumPrice = Math.max(0, demandIntercept + params.demandSlope * quantitySupplied);
            
            let currentPrice, quantityDemanded, quantityTransacted;
            if (params.priceControl !== null) {
                currentPrice = params.priceControl;
                quantityDemanded = (currentPrice - demandIntercept) / params.demandSlope;
                quantityTransacted = Math.min(quantityDemanded, quantitySupplied);
            } else {
                currentPrice = equilibriumPrice;
                quantityDemanded = quantitySupplied;
                quantityTransacted = quantitySupplied;
            }

            // Update Supply & Demand Curves
            supplyCurve.attr("x1", x(quantitySupplied)).attr("y1", y(0)).attr("x2", x(quantitySupplied)).attr("y2", y(500));
            const demandEndpoints = getClippedLineEndpoints(params.demandSlope, demandIntercept, x.domain(), y.domain());
            if (demandEndpoints) {
                demandCurve.attr("x1", x(demandEndpoints[0].x)).attr("y1", y(demandEndpoints[0].y)).attr("x2", x(demandEndpoints[1].x)).attr("y2", y(demandEndpoints[1].y));
                demandDraggable.attr("x1", x(demandEndpoints[0].x)).attr("y1", y(demandEndpoints[0].y)).attr("x2", x(demandEndpoints[1].x)).attr("y2", y(demandEndpoints[1].y));
            }

            // Update Equilibrium/Transaction Point
            equilPoint.attr("cx", x(quantityTransacted)).attr("cy", y(currentPrice));
            equilDropQ.attr("x1", x(quantityTransacted)).attr("y1", y(0)).attr("x2", x(quantityTransacted)).attr("y2", y(currentPrice));
            equilDropP.attr("x1", x(0)).attr("y1", y(currentPrice)).attr("x2", x(quantityTransacted)).attr("y2", y(currentPrice));

            // Update Price Control and Imbalance Visuals
            imbalanceArea.style("visibility", "hidden");
            imbalanceLabel.style("visibility", "hidden");
            if (params.priceControl !== null) {
                controlledPriceLine.style("visibility", "visible")
                    .attr("x1", x(0)).attr("y1", y(currentPrice))
                    .attr("x2", x(x.domain()[1])).attr("y2", y(currentPrice));

                const imbalance = quantityDemanded - quantitySupplied;
                if (Math.abs(imbalance) > 0.1) {
                    imbalanceArea.style("visibility", "visible");
                    imbalanceLabel.style("visibility", "visible");
                    const yPos = y(currentPrice) - 15;
                    if (imbalance > 0) { // Shortage
                        imbalanceArea.attr("class", "imbalance-area shortage")
                            .attr("x", x(quantitySupplied)).attr("y", yPos)
                            .attr("width", x(quantityDemanded) - x(quantitySupplied));
                        imbalanceLabel.attr("fill", "var(--shortage-stroke)").attr("x", x(quantitySupplied + imbalance / 2)).attr("y", yPos - 5).text(`Shortage: ${Math.round(imbalance)}`);
                    } else { // Surplus
                        imbalanceArea.attr("class", "imbalance-area surplus")
                            .attr("x", x(quantityDemanded)).attr("y", yPos)
                            .attr("width", x(quantitySupplied) - x(quantityDemanded));
                        imbalanceLabel.attr("fill", "var(--surplus-stroke)").attr("x", x(quantityDemanded - imbalance / 2)).attr("y", yPos - 5).text(`Surplus: ${Math.round(-imbalance)}`);
                    }
                }
            } else {
                controlledPriceLine.style("visibility", "hidden");
            }
            
            // Update Readouts
            els.demandVal.text(dShift >= 0 ? `+${dShift}` : dShift);
            els.rPrice.text(`$${d3.format(",.1f")(currentPrice)}M`);
            els.rQuantity.text(d3.format(",.0f")(quantityTransacted));

            const imbalance = quantityDemanded - quantitySupplied;
            if (params.priceControl === null || Math.abs(imbalance) < 0.1) {
                els.rStatus.text("Equilibrium").attr("class", "val");
                els.rStatusSub.text(`Qd (${Math.round(quantityDemanded)}) = Qs (${quantitySupplied})`);
            } else if (imbalance > 0) {
                els.rStatus.text("Shortage").attr("class", "val danger");
                els.rStatusSub.text(`Qd (${Math.round(quantityDemanded)}) > Qs (${quantitySupplied})`);
            } else {
                els.rStatus.text("Surplus").attr("class", "val info");
                els.rStatusSub.text(`Qd (${Math.round(quantityDemanded)}) < Qs (${quantitySupplied})`);
            }
        }

        // --- 4. EVENT LISTENERS & DRAGGING ---
        els.demandSlider.on("input", function() { params.demandShift = this.value; update(); });

        els.priceControlSlider.on("input", function() {
            params.priceControl = +this.value;
            els.priceControlVal.text(`$${this.value}M`);
            update();
        });

        els.btnMarketPrice.on("click", () => {
            params.priceControl = null;
            els.priceControlSlider.attr("disabled", true);
            els.btnMarketPrice.classed("active", true);
            els.btnSetPrice.classed("active", false);
            update();
        });

        els.btnSetPrice.on("click", () => {
            const equilibriumPrice = Math.max(0, (params.baseIntercept + +params.demandShift) + params.demandSlope * params.fixedQuantity);
            els.priceControlSlider.node().value = equilibriumPrice;
            params.priceControl = equilibriumPrice;
            els.priceControlVal.text(`$${Math.round(equilibriumPrice)}M`);
            els.priceControlSlider.attr("disabled", null);
            els.btnMarketPrice.classed("active", false);
            els.btnSetPrice.classed("active", true);
            update();
        });

        const demandDragHandler = d3.drag().on("drag", function(event) {
            let newIntercept = y.invert(event.y) - params.demandSlope * x.invert(event.x);
            let newVal = newIntercept - params.baseIntercept;
            newVal = Math.round(Math.max(-200, Math.min(200, newVal)));
            params.demandShift = newVal;
            els.demandSlider.node().value = newVal;
            update();
        });

        demandDraggable.call(demandDragHandler);

        // --- 5. INITIAL DRAW ---
        update();
    </script>
</body>
</html>